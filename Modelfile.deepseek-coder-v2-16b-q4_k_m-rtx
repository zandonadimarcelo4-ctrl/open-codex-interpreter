# Modelfile otimizado para DeepSeek-Coder-V2:16b com Q4_K_M
# Otimizado para GPU NVIDIA RTX 4080 Super (16GB VRAM)
# Fonte: https://ollama.com/library/deepseek-coder-v2
# 
# Configurações otimizadas para:
# - RTX 4080 Super com 16GB VRAM
# - Context window: 65,536 tokens
# - Batch size: 2048
# - Máxima performance em GPU

# Modelo base oficial do Ollama (já quantizado, mas vamos usar como base)
FROM deepseek-coder-v2:16b

# Sistema de prompt otimizado para código
SYSTEM """You are DeepSeek Coder V2, an expert AI assistant specialized in programming and code generation.
You are a Mixture-of-Experts (MoE) code language model with performance comparable to GPT4-Turbo in code-specific tasks.

You write clean, efficient, and well-documented code.
Focus on:
- Code quality and best practices
- Clear, concise explanations
- Error handling and edge cases
- Performance optimization when relevant
- Multi-language support (Python, JavaScript, TypeScript, Go, Rust, C++, etc.)

Always provide complete, working code solutions with proper error handling."""

# Template otimizado para DeepSeek-Coder-V2 (formato oficial)
TEMPLATE """<|start_header_id|>system<|end_header_id|>

{{ .System }}<|eot_id|><|start_header_id|>user<|end_header_id|>

{{ .Prompt }}<|eot_id|><|start_header_id|>assistant<|end_header_id|>

{{ .Response }}<|eot_id|>"""

# ============================================
# PARÂMETROS OTIMIZADOS PARA RTX NVIDIA GPU
# ============================================

# Temperature: 0.2 (muito determinístico, ideal para código)
PARAMETER temperature 0.2

# Top-p: 0.9 (sampling focado, mantém qualidade)
PARAMETER top_p 0.9

# Top-k: 40 (boa qualidade, ainda rápido)
PARAMETER top_k 40

# Context window: 65536 (RTX 4080 Super 16GB suporta contexto grande)
PARAMETER num_ctx 65536

# Max tokens: 16384 (respostas muito completas, RTX 4080 Super 16GB suporta)
PARAMETER num_predict 16384

# Repeat penalty: 1.1 (evitar repetição)
PARAMETER repeat_penalty 1.1

# Repeat last N tokens: 128 (mais contexto para RTX 4080 Super)
PARAMETER repeat_last_n 128

# Threads: 16 (CPU auxilia, GPU faz trabalho pesado)
PARAMETER num_thread 16

# Batch size: 2048 (RTX 4080 Super 16GB suporta batches muito grandes)
PARAMETER num_batch 2048

# GPU layers: TODAS (forçar uso completo da GPU RTX 4080 Super 16GB)
# RTX 4080 Super 16GB: usar todas as camadas na GPU para máxima performance
PARAMETER num_gpu 99

# Flash Attention: habilitado (acelera muito em RTX)
PARAMETER flash_attention true

# Stop sequences (padrão DeepSeek-Coder-V2)
PARAMETER stop "<|start_header_id|>"
PARAMETER stop "<|end_header_id|>"
PARAMETER stop "<|eot_id|>"
PARAMETER stop "```"
PARAMETER stop "System:"
PARAMETER stop "User:"
PARAMETER stop "Assistant:"

# Seed: -1 (aleatório, mas determinístico por padrão)
PARAMETER seed -1

# TFS: 1.0 (sem filtro de cauda)
PARAMETER tfs_z 1.0

# Typical p: 1.0 (sem filtro típico)
PARAMETER typical_p 1.0

# Mirostat: 0 (desabilitado para performance máxima)
PARAMETER mirostat 0

# Penalize newlines: false (permitir múltiplas linhas de código)
PARAMETER penalize_newline false

# Logits all: false (não retornar todos os logits, economiza memória GPU)
PARAMETER logits_all false

# Use mmap: true (mapeamento de memória, mais eficiente em GPU)
PARAMETER use_mmap true

# Use mlock: false (não travar memória, deixa GPU gerenciar)
PARAMETER use_mlock false

# NUMA: false (NVIDIA não precisa de NUMA)
PARAMETER numa false

